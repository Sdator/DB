# å®¹å™¨è¸©å‘ä¹‹è·¯

- [å®¹å™¨è¸©å‘ä¹‹è·¯](#å®¹å™¨è¸©å‘ä¹‹è·¯)
  - [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
  - [W10 WSL2 çŽ©å®¹å™¨](#w10-wsl2-çŽ©å®¹å™¨)
  - [systemdctl æœåŠ¡å¯åŠ¨èµ·æ¥](#systemdctl-æœåŠ¡å¯åŠ¨èµ·æ¥)
  - [æœåŠ¡å¯åŠ¨æŠ¥é”™ iptables é—®é¢˜](#æœåŠ¡å¯åŠ¨æŠ¥é”™-iptables-é—®é¢˜)
  - [å¼€å¯ tcp è¿œç¨‹è¿žæŽ¥å’Œ daemon.json é…ç½®](#å¼€å¯-tcp-è¿œç¨‹è¿žæŽ¥å’Œ-daemonjson-é…ç½®)
  - [è¸©å‘](#è¸©å‘)
    - [Windows å¹³å°ä¸‹æ­£ç¡®è¯»å–è·¯å¾„çš„æ–¹æ³•](#windows-å¹³å°ä¸‹æ­£ç¡®è¯»å–è·¯å¾„çš„æ–¹æ³•)

## å‡†å¤‡å·¥ä½œ

- çŽ¯å¢ƒ
  - W10 2004
  - vscode

## W10 WSL2 çŽ©å®¹å™¨

- æœ‰ä¸¤ç§å®‰è£…æ–¹å¼
  - linux åŽŸç”ŸåŒ…å®‰è£…æ³•æˆ–å®˜æ–¹æä¾›çš„ä¸€é”®è„šæœ¬å®‰è£… ðŸ‘ï¼ˆä½ æƒ³æŠ˜è…¾å—é‚£å°±å¯¹äº† ðŸš‘ï¼‰
  - æ­é… docker for window å®‰è£…ä¸å¥½ ðŸ˜’

## systemdctl æœåŠ¡å¯åŠ¨èµ·æ¥

- ç”±äºŽ wsl2 çš„ systemctl æœ‰ç‚¹é—®é¢˜
- å»ºè®®ç”¨ service

  ```bash
  sudo apt-get install daemonize
  sudo daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit=basic.target
  exec sudo nsenter -t $(pidof systemd) -a su - $LOGNAME
  ```

- å¤‡ç”¨æ–¹æ³•æœªæµ‹è¯•

  ```bash
  mv /usr/bin/systemctl /usr/bin/systemctl.old
  curl https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py > /usr/bin/systemctl
  chmod +x /usr/bin/systemctl
  ```

## æœåŠ¡å¯åŠ¨æŠ¥é”™ iptables é—®é¢˜

```bash
# å› ä¸ºå®¹å™¨åœ¨å¯åŠ¨ä¸­ä½¿ç”¨äº† iptables è¿›è¡Œ nat è½¬å‘,ç”±äºŽdebian é»˜è®¤ä½¿ç”¨ nftablesï¼Œä½ å¯ä»¥æŠŠè½¬å‘æ¡ç›®è½¬æ¢ä¸º nftables ,æˆ–è€…ä½¿ç”¨æ—§ç‰ˆ iptables
sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy

# åœ¨æ²¡æœ‰ iptables è§„åˆ™çš„æƒ…å†µä¸‹è¿è¡Œ dockerd æœåŠ¡
dockerd --iptables=false
```

- æŠ¥é”™ä¿¡æ¯

  > failed to start daemon: Error initializing network controller: error obtaining controller instance: failed to create NAT chain DOCKER: iptables failed: iptables --wait -t nat -N DOCKER: iptables v1.8.2 (nf_tables): CHAIN_ADD failed (No such file or directory): chain PREROUTING

- å‚è€ƒ
- https://forums.docker.com/t/failing-to-start-dockerd-failed-to-create-nat-chain-docker/78269
- https://blog.csdn.net/w851685279/article/details/108825893
- https://blog.csdn.net/weixin_42195311/article/details/108467171

## å¼€å¯ tcp è¿œç¨‹è¿žæŽ¥å’Œ daemon.json é…ç½®

- ä»¥ä¸‹åœ°å€æ›¿æ¢æˆä½ è‡ªå·±çš„,é™¤äº† 0.0.0.0

  ```bash
  # è®¾ç½®åœ°å€
  cat > /etc/docker/daemon.json <<EOF
  {
    "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2378"],   # æ‰“å¼€è¿œç¨‹æœåŠ¡
    "registry-mirrors": ["https://registry.docker-cn.com"],           # é•œåƒåŠ é€Ÿåœ°å€
    "iptables": false,                                                # ä¸ä½¿ç”¨ ptables å¯ä»¥è§£å†³éƒ¨åˆ†å¹³å°æŠ¥é”™

  }
  EOF

  # ä¸´æ—¶è®¾ç½®è¿œç¨‹æœåŠ¡ä¸»æœºåœ°å€
  $Env:DOCKER_HOST = "tcp://172.25.176.176:2378"
  # å›ºåŒ–çŽ¯å¢ƒå˜é‡
  [environment]::SetEnvironmentvariable("DOCKER_HOST", "tcp://172.25.176.176:2378", "User")

  # vscode å•ç‹¬é…ç½®
  "docker.host": "tcp://172.25.176.176:2378"

  ```

## è¸©å‘

### Windows å¹³å°ä¸‹æ­£ç¡®è¯»å–è·¯å¾„çš„æ–¹æ³•

- çŽ¯å¢ƒ
  - W10 å¹³å°
  - git-bash
- å…³é”®å‘½ä»¤
  - $(cmd //c echo %CD%)
- é—®é¢˜
  - åœ¨ Window ä¸‹ä½¿ç”¨ git-bash æ‰§è¡Œå®¹å™¨å¦‚ä½•é€šè¿‡å‘½ä»¤ä»£å…¥æ­£ç¡®çš„è·¯å¾„ï¼Ÿ
- è§£å†³æ–¹æ¡ˆ

  - åœ¨ WSL2 ä¸­æ‰§è¡Œå®¹å™¨ç›¸å…³æŒ‡ä»¤å³å¯è§£å†³ Window å¹³å°çš„å„ç§é—®é¢˜

  ```bash
  docker run --rm -v $(cmd //c echo %CD%):/tmp -it sdator/tools ls -al
  ```

- é”™è¯¯ä¾‹å­

  ```bash
  # ä½†é€‚åˆ linux å¹³å°
  docker run --rm -v `pwd`:/tmp -it sdator/tools ls -al
  docker run --rm -v $(pwd):/tmp -it sdator/tools ls -al
  docker run --rm -v "${pwd}":/tmp -it sdator/tools ls -al
  ```

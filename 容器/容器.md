# å®¹å™¨è®°å½•

- çŽ¯å¢ƒ
  - W10 å¹³å°

## WSL2 çŽ©å®¹å™¨

- æœ‰ä¸¤ç§å®‰è£…æ–¹å¼
  - linux åŽŸç”Ÿå®‰è£…ï¼Œä½¿ç”¨å®˜æ–¹æä¾›çš„è„šæœ¬å®‰è£…
  - æ­é… docker for window å®‰è£…

### è§£å†³è¿è¡Œé—®é¢˜

#### systemdctl æœåŠ¡å¯åŠ¨èµ·æ¥

```bash
# å®‰è£…daemonize
sudo apt-get install daemonize
# æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¼€å¯
sudo daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit=basic.target
exec sudo nsenter -t $(pidof systemd) -a su - $LOGNAME
```

å¤‡ç”¨æ–¹æ³•æœªæµ‹è¯•

```bash
mv /usr/bin/systemctl /usr/bin/systemctl.old
curl https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py > /usr/bin/systemctl
chmod +x /usr/bin/systemctl
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç‰ˆæƒå£°æ˜Žï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€ŒçŒªåœºå°‘å¹´ã€çš„åŽŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŽŸæ–‡å‡ºå¤„é“¾æŽ¥åŠæœ¬å£°æ˜Žã€‚
åŽŸæ–‡é“¾æŽ¥ï¼šhttps://blog.csdn.net/weixin_42195311/article/details/108467171
```

#### æœåŠ¡å¯åŠ¨æŠ¥é”™ iptables é—®é¢˜ ðŸ‘

```bash
# å› ä¸ºå®¹å™¨åœ¨å¯åŠ¨ä¸­ä½¿ç”¨äº† iptables è¿›è¡Œ nat è½¬å‘,ç”±äºŽdebian é»˜è®¤ä½¿ç”¨ nftablesï¼Œä½ å¯ä»¥æŠŠè½¬å‘æ¡ç›®è½¬æ¢ä¸º nftables ,æˆ–è€…ä½¿ç”¨æ—§ç‰ˆ iptables
sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy

# åœ¨æ²¡æœ‰ iptables è§„åˆ™çš„æƒ…å†µä¸‹è¿è¡Œ dockerd æœåŠ¡
dockerd --iptables=false
```

æŠ¥é”™ä¿¡æ¯

> failed to start daemon: Error initializing network controller: error obtaining controller instance: failed to create NAT chain DOCKER: iptables failed: iptables --wait -t nat -N DOCKER: iptables v1.8.2 (nf_tables): CHAIN_ADD failed (No such file or directory): chain PREROUTING

å‚è€ƒ

- https://forums.docker.com/t/failing-to-start-dockerd-failed-to-create-nat-chain-docker/78269
- https://blog.csdn.net/w851685279/article/details/108825893
- https://blog.csdn.net/weixin_42195311/article/details/108467171?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control

## å¼€å¯ tcp è¿œç¨‹è¿žæŽ¥

```bash
cat > /etc/docker/daemon.json <<EOF
{
"hosts": ["tcp://0.0.0.0:2376","unix:///var/run/docker.sock"]
}
EOF

cat > /etc/docker/daemon.json <<EOF
{
  "hosts": ["unix:///var/run/docker.sock", "tcp://127.0.0.1:2375"],
  "registry-mirrors": ["https://registry.docker-cn.com"]
}
EOF

# è®¾ç½®è¿œç¨‹æœåŠ¡ä¸»æœºåœ°å€
$Env:DOCKER_HOST = "tcp://x.x.x.x:2376"

```

## è¸©å‘

- çŽ¯å¢ƒ
  - W10 å¹³å°
  - git-bash
- å…³é”®å‘½ä»¤
  - $(cmd //c echo %CD%)
- é—®é¢˜
  - åœ¨ Window ä¸‹ä½¿ç”¨ git-bash æ‰§è¡Œå®¹å™¨å¦‚ä½•é€šè¿‡å‘½ä»¤ä»£å…¥æ­£ç¡®çš„è·¯å¾„ï¼Ÿ
- è§£å†³æ–¹æ¡ˆ
  - åœ¨ WSL2 ä¸­æ‰§è¡Œå®¹å™¨ç›¸å…³æŒ‡ä»¤å³å¯è§£å†³ Window å¹³å°çš„å„ç§é—®é¢˜

### Windows å¹³å°ä¸‹æ­£ç¡®è¯»å–è·¯å¾„çš„æ–¹æ³•

```bash
docker run --rm -v $(cmd //c echo %CD%):/tmp -it sdator/tools ls -al
```

### é”™è¯¯ä¾‹å­

```bash
# ä½†é€‚åˆ linux å¹³å°
docker run --rm -v `pwd`:/tmp -it sdator/tools ls -al
docker run --rm -v $(pwd):/tmp -it sdator/tools ls -al
docker run --rm -v "${pwd}":/tmp -it sdator/tools ls -al
```
